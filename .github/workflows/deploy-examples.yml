name: Deploy Python Examples

on:
  push:
    branches: [ "main", "development" ]
    paths:
      - 'src/aws_durable_execution_sdk_python_testing/**'
      - 'examples/**'
      - '.github/workflows/deploy-examples.yml'
  pull_request:
    branches: [ "main", "development"]
    paths:
      - 'src/aws_durable_execution_sdk_python_testing/**'
      - 'examples/**'
      - '.github/workflows/deploy-examples.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-west-2

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      function-name-map: ${{ steps.deploy-functions.outputs.function-name-map }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.SDK_KEY }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Configure AWS credentials
      if: github.event_name != 'workflow_dispatch' || github.actor != 'nektos/act'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: "${{ secrets.ACTIONS_INTEGRATION_ROLE_NAME }}"
        role-session-name: pythonTestingLibraryGitHubIntegrationTest
        aws-region: ${{ env.AWS_REGION }}

    - name: Install Hatch
      run: pip install hatch

    - name: Build examples
      run: hatch run examples:build

    - name: Deploy functions
      id: deploy-functions
      env:
        AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
        INVOKE_ACCOUNT_ID: ${{ secrets.INVOKE_ACCOUNT_ID }}
        KMS_KEY_ARN: ${{ secrets.KMS_KEY_ARN }}
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_EVENT_NUMBER: ${{ github.event.number }}
      run: |
        # Read examples catalog and deploy each function
        FUNCTION_NAME_MAP="{}"
        
        for row in $(jq -r '.examples[] | select(.integration == true) | @base64' examples/examples-catalog.json); do
          _jq() {
            echo ${row} | base64 --decode | jq -r ${1}
          }
          
          EXAMPLE_HANDLER=$(_jq '.handler')
          EXAMPLE_NAME=$(_jq '.name')
          EXAMPLE_NAME_CLEAN=$(echo "$EXAMPLE_NAME" | sed 's/ //g')
          HANDLER_FILE=$(echo $EXAMPLE_HANDLER | sed 's/\.handler$//')
          
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            FUNCTION_NAME="${EXAMPLE_NAME_CLEAN}-Python-PR-$GITHUB_EVENT_NUMBER"
          else
            FUNCTION_NAME="${EXAMPLE_NAME_CLEAN}-Python"
          fi
          
          echo "Deploying $HANDLER_FILE as $FUNCTION_NAME"
          hatch run examples:deploy "$HANDLER_FILE" "$FUNCTION_NAME"
          
          # Add to function name map
          FUNCTION_NAME_MAP=$(echo $FUNCTION_NAME_MAP | jq --arg key "$HANDLER_FILE" --arg value "$FUNCTION_NAME" '. + {($key): $value}')
        done
        
        echo "function-name-map<<EOF" >> $GITHUB_OUTPUT
        echo "$FUNCTION_NAME_MAP" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "Function name map: $FUNCTION_NAME_MAP"

  test:
    needs: deploy
    runs-on: ubuntu-latest
    strategy:
      matrix:
        example: ${{ fromJson(needs.deploy.outputs.function-name-map) }}
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: |
          ${{ secrets.LANGUAGE_SDK_SSH_PRIVATE_KEY }}
          ${{ secrets.TESTING_SSH_PRIVATE_KEY }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Configure AWS credentials
      if: github.event_name != 'workflow_dispatch' || github.actor != 'nektos/act'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: "${{ secrets.ACTIONS_INTEGRATION_ROLE_NAME }}"
        role-session-name: pythonTestingLibraryGitHubIntegrationTest
        aws-region: ${{ env.AWS_REGION }}

    - name: Invoke Lambda function
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
        FUNCTION_NAME: ${{ matrix.example }}
      run: |
        echo "Testing function: $FUNCTION_NAME"
        aws lambda invoke \
          --function-name "$FUNCTION_NAME" \
          --cli-binary-format raw-in-base64-out \
          --payload '{"name": "World"}' \
          --region "${{ env.AWS_REGION }}" \
          --endpoint-url "$LAMBDA_ENDPOINT" \
          /tmp/response.json
        echo "Response:"
        cat /tmp/response.json

    - name: Find Durable Execution
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
        FUNCTION_NAME: ${{ matrix.example }}
      run: |
        echo "Listing durable executions for function: $FUNCTION_NAME"
        aws lambda list-durable-executions \
          --function-name "$FUNCTION_NAME" \
          --region "${{ env.AWS_REGION }}" \
          --endpoint-url "$LAMBDA_ENDPOINT" \
          --cli-binary-format raw-in-base64-out \
          --status-filter SUCCEEDED \
          > /tmp/executions.json
        echo "Durable Executions:"
        cat /tmp/executions.json
        
        # Extract the first execution ARN for history retrieval
        EXECUTION_ARN=$(jq -r '.DurableExecutions[0].DurableExecutionArn // empty' /tmp/executions.json)
        echo "EXECUTION_ARN=$EXECUTION_ARN" >> $GITHUB_ENV

    - name: Get Durable Execution History
      if: env.EXECUTION_ARN != ''
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
      run: |
        echo "Getting execution history for: $EXECUTION_ARN"
        aws lambda get-durable-execution-history \
          --durable-execution-arn "$EXECUTION_ARN" \
          --region "${{ env.AWS_REGION }}" \
          --endpoint-url "$LAMBDA_ENDPOINT" \
          --cli-binary-format raw-in-base64-out \
          > /tmp/history.json
        echo "Execution History:"
        cat /tmp/history.json

  cleanup:
    needs: [deploy, test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SDK_KEY }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Configure AWS credentials
      if: github.event_name != 'workflow_dispatch' || github.actor != 'nektos/act'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: "${{ secrets.ACTIONS_INTEGRATION_ROLE_NAME }}"
        role-session-name: pythonTestingLibraryGitHubIntegrationTest
        aws-region: ${{ env.AWS_REGION }}

    - name: Install Hatch
      run: pip install hatch

    - name: Cleanup Lambda functions
      env:
        LAMBDA_ENDPOINT: ${{ secrets.LAMBDA_ENDPOINT }}
        FUNCTION_NAME_MAP: ${{ needs.deploy.outputs.function-name-map }}
      run: |
        # Delete deployed functions
        echo "Cleaning up functions: $FUNCTION_NAME_MAP"
        
        for function_name in $(echo $FUNCTION_NAME_MAP | jq -r '.[]'); do
          echo "Deleting function: $function_name"
          aws lambda delete-function --function-name "$function_name" --endpoint-url "$LAMBDA_ENDPOINT" --region "$AWS_REGION" || true
        done
